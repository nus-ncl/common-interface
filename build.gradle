buildscript {
    repositories {
        jcenter()
    }

    dependencies {
        classpath("org.springframework.boot:spring-boot-gradle-plugin:1.3.5.RELEASE")
    }
}
// settings for all projects
allprojects {
    apply plugin: 'java'
    apply plugin: 'eclipse'
    apply plugin: 'idea'
    apply plugin: 'io.spring.dependency-management'
    apply plugin: 'jacoco'

    group 'sg.ncl'

    sourceCompatibility = JavaVersion.VERSION_1_8
    targetCompatibility = JavaVersion.VERSION_1_8

    repositories {
        jcenter()
    }

    dependencyManagement {
        dependencies {
//            dependencySet(group: 'org.hibernate', version: '5.1.0.Final') {
//                entry 'hibernate-core'
//                entry 'hibernate-entitymanager'
//            }
            dependency 'io.jsonwebtoken:jjwt:0.6.0'
        }

        imports {
            mavenBom 'io.spring.platform:platform-bom:2.0.5.RELEASE'
        }
    }

    sourceSets {
        integrationTest {
            compileClasspath += main.output + test.output
            runtimeClasspath += main.output + test.output

            java {
                srcDir 'src/test-integration/java'
            }

            resources {
                srcDir 'src/test-integration/resources'
            }
        }
    }

    configurations {
        integrationTestCompile {
            extendsFrom testCompile
        }
        integrationTestRuntime {
            extendsFrom testRuntime
        }
    }

    idea {
        module {
            testSourceDirs += sourceSets.integrationTest.java.srcDirs
            testSourceDirs += sourceSets.integrationTest.resources.srcDirs
        }
    }

    task integrationTest(type: Test) {
        group 'verification'
        check {
            dependsOn integrationTest
        }
        testClassesDir sourceSets.integrationTest.output.classesDir
        classpath = sourceSets.integrationTest.runtimeClasspath
    }

    task testReport(type: TestReport) {
        group 'reporting'
        dependsOn check
        destinationDir file("${reporting.baseDir}/unified/html")
        reportOn test, integrationTest
    }

    tasks.withType(Test) {
        group 'verification'
        reports {
            html {
                destination file("${reporting.baseDir}/${task.name}/html")
            }
        }
    }

    tasks.withType(JacocoReport) {
        group 'reporting'
        executionData test, integrationTest
        // temporary hack to fix a bug requiring that there be at least one test case in each source set for coverage data to be generated;
        // it should be if there is at least one test case in any of the source sets
//        executionData = files(executionData.findAll({ it.exists() }))
    }
}

configure(subprojects.findAll({ it.name.startsWith('service-') })) {
    apply plugin: 'spring-boot'
}

apply plugin: 'spring-boot'

version '1.0-SNAPSHOT'

dependencies {
    // the only compile dependencies needed here are the services projects;
    // there should be no other compile dependencies
    compile subprojects.findAll({ it.name.startsWith('service-') })
    // the runtime dependencies should be a union of all runtime dependencies needed by all subprojects
    runtime 'mysql:mysql-connector-java'

    testCompile 'junit:junit'
}

testReport {
    dependsOn check, subprojects.testReport
    reportOn test, integrationTest, subprojects.test, subprojects.integrationTest
}

task jacocoMerge(type: JacocoMerge) {
    executionData test, integrationTest, subprojects.test, subprojects.integrationTest
    // temporary hack to fix a bug requiring that there be at least one test case in each source set for coverage data to be generated;
    // it should be if there is at least one test case in any of the source sets
    executionData = files(executionData.findAll({ it.exists() }))
}

task mergeJacocoTestReport(type: JacocoReport) {
    dependsOn check, subprojects.jacocoTestReport, jacocoMerge
    executionData jacocoMerge.destinationFile
    // temporary hack to fix a bug requiring that there be at least one test case in each source set for coverage data to be generated;
    // it should be if there is at least one test case in any of the source sets
    executionData = files(executionData.findAll({ it.exists() }))
    sourceDirectories = files(sourceSets.main.java.srcDirs, subprojects.sourceSets.main.java.srcDirs)
    classDirectories = files(sourceSets.main.output.classesDir, subprojects.sourceSets.main.output.classesDir)
}

task wrapper(type: Wrapper) {
    gradleVersion '2.14'
    distributionUrl "https://services.gradle.org/distributions/gradle-${gradleVersion}-all.zip"
}
